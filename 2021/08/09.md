> 2021 08.09 - 08.10

# 쿠버네티스 오브젝트

* 데몬셋  
  디플로이먼트의 replicas 가 노드 수 만큼 정해져 있는 형태.
  노드를 관리하는 파드라면 데몬셋으로 만드는 것이 효율적이다.

* 컨피그맵  
  설정(config)을 목적으로 사용하는 오브젝트이다. 

* PV / PVC  
  파드는 언제든 생성되고 삭제된다. 하지만 때로는 파드에서 생성된 내용을 보관하거나 모든 파드가 동일한 설정 값을 유지하고 관리하기 위해 공유된 볼륨으로부터 공통된 설정으로 가지고 올 수 있어야 한다.  

  쿠버네티스는 필요할 때 PVC 를 요청해 사용한다. PVC 를 사용하려면 PV 로 볼륨을 선언해야 한다. PV 는 볼륨을 사용할 수 있게 준비하는 단계고 PVC 는 준비된 볼륨에서 일정 공간을 할당받는 것이다. 

* 스테이트풀셋  
  파드가 만들어지는 이름과 순서를 예측해서 생성해야 할 때 사용한다. 스테이트풀셋은 volumeClaimTemplates 기능을 사용해 PVC를 자동으로 생성할 수 있고 파드가 순서대로 생성되기 때문에 고정된 이름, 볼륨, 설정등을 가질 수 있다. 

# 도커

쿠버네티스 시스템을 살펴보면 파드들은 워커 노드라는 노드 단위로 관리하며 워커 노드와 마스터 노드가 모여 쿠버네티스 클러스터가 된다. 그리고 파드는 1개 이상의 컨테이너로 이루어져 있다. 

파드는 쿠버네티스로부터 IP를 받아 컨테이너가 외부와 통신할 수 있는 경로를 제공한다. 그리고 네트워크나 저장 공간을 서로 공유한다. 파드가 이런 환경을 만들기 때문에 컨터이너들은 하나의 호스트에 존재하는 것처럼 작동할 수 있다. 

## 도커 이미지

* 태그  
  이름이 동일한 이미지에 추가하는 식별자. 버전이나 플랫폼이 다들 수 있기 때문에 이를 구분할 때 사용한다. 태그를 명시하지 않으면 latest 최신버전을 기본으로 사용한다.

* 레이어  
  컨테이너 이미지는 애플리케이션과 각종 파일을 담고 있는 점에서 압축 파일에 더 가깝다. 하지만 압축파일은 같은 종류의 파일이 있더라도 개수에 따라 용량이 증가하는데 이미지는 같은 내용일 경우 여러 이미지에서 동일한 레이어를 공유해서 전체 용량이 감소한다.

컨테이너 내부에서 외부 파일 사용하는 방법

1. docker cp :   
  호스트에 위치한 파일을 구동 중인 컨테이너 내부에 복사한다. 
2. Dockerfile ADD :  
   이미지는 Dockerfile 을 기반으로 만들어진다. 이 때 ADD 라는 구문으로 컨테이너 내부로 복사할 파일을 지정하면 이미지를 빌드할 때 지정한 파일이 이미지 내부로 복사된다.
3. 바인드 마운드 :  
   호스트의 파일 시스템과 컨테이너 내부를 연결해 어느 한 쪽에서 작업한 내용이 양쪽에 동시에 반영되는 방법이다. 
4. 볼륨 : 호스트의 파일 시스템과 컨테이너 내부를 연결하는 것은 바인드 마운트와 동일 하지만 호스트의 특정 디렉토리가 아닌 도커가 관리하는 불륨을 컨테이너와 연결한다. 따라서 도커가 관리하는 볼륨 공간을 NFS 와 같은 공유 디렉토리에 생성한다면 다른 호스트에서도 도커가 관리하는 볼륨을 함께 사용 가능하다. 

이 중 바인드 마운트 와 볼륨을 이용해 내부 파일을 변경해봤다.

## 마인트 바운트 

nginx 컨테이너의 index.html 의 경로는 /usr/share/nginx/html/index.html 이다.  

```bash
# 컨테이너 내부에 연결할 /root/html/ 디렉토리를 생성
mkdir -p /root/html

# 컨테이너 내부 디렉토리와 호스트 디렉토리를 연결한 nginx 컨테이너를 구동한다.
docker run -d -p 8081:80 -v /root/html:/usr/share/nginx/html --restart always --name nginx-bind-mounts nginx

# 바인드 마운트는 호스트 디렉토리를 컨테이너 디렉토리를 덮어씌우는 것이므로 해당 컨테이너 디렉토리는 비어있다. 때문에 웹으로 컨테이너에 접속해보면 오류 화면이 나온다.

# 원하는 html 파일을 /root/html 에 복사한다.
cp -r ~/myweb/index.html /root/index/index.html

# 브라우저로 접속하면 html 이 표시된다.
```

## 볼륨

볼륨은 도커가 직접 관리하며 컨테이너에 제공하는 호스트 공간이다. 

```bash
# 도커 볼륨을 생성한다.
docker volume create nginx-volume

# 생성한 볼륨을 컨테이너 내부 디렉토리와 연결하여 컨테이너를 구동한다.
docker run -d -p 8082:80 -v nginx-volume:/usr/share/nginx/html --restart always --name nginx-volume nginx

# 볼륨은 컨테이너 디렉토리에 파일을 가져온 것을 확인 할 수 있다. 
ls /var/lib/docker/volumes/nginx-volume/_data

# 원하는 파일을 볼륨 디렉토리에 옮겨서 확인할 수 있다.
cp -r ~/myweb/index.html /var/lib/docker/volumes/nginx-volume/_data
```

## 도커 이미지 빌드하기

* 멀티 스테이지 빌드  
  자바 소스를 빌드해 JAR 로 변환 후 이미지 파일을 만들어야 하는데 이 때 소스를 빌드하는 위치와 최종결과물을 가진 이미지를 분리하여 빌드하는 것이다. 

  예로 들러  자바 소스를 변환하기 위해 openjdk 를 이용해야 한다. opendjdk 이미지 내에서 빌드를 진행하고 컨테이너를 구동하면 빌드하는 과정에서 생성된 파일과 내려받은 라이브러리 캐시들이 최종 이미지에 남게 되면서 용량이 커진다.

  이를 방지하기 위해 빌드 따로 빌드 후 JAR 을 이용해 컨테이너가 구동되는 이미지 따로 만드는 것이다. 


## 도커 이미지 쿠버네티스에서 사용하기

도커를 이용해서 이미지를 만들었다면 쿠버네티스에서 해당 이미지로 컨테이너를 구동시켜야 한다. 이 때 뭐든 노드에서 사용할 수 있게 접근하는 방법은 기본으로 사용하는 도커 허브에 이미지를 업로드 시키는 것과 쿠버네티스가 접근할 수 있는 곳에 이미지 레지스트리를 만들고 그곳에서 받아오도록 설정하는 것이다. 

레지스트리를 만드는 기본 이미지는 도커 허브에 올려져있다. 해당 이미지를 내려받아 컨테이너를 구동시키면 레지스트리를 사용할 수 있다. 

해당 레지스트리에 이미지를 등록하는 법은 이미지의 이름을 [포트 번호]/[이미지 이름] 으로 수정 후에 푸쉬하면 된다. 